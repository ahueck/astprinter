name: ASTPrinter-CI

on:
  push:
    branches: [ main, devel ]
  pull_request:

env:
  CXX: clang++
  CC: clang

jobs:
  format-check:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v5

      - run: |
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          echo "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-18 main" | sudo tee /etc/apt/sources.list.d/llvm-18.list

      - name: Update apt
        run: sudo apt-get update

      - name: Install clang-format
        run: |
          sudo apt-get remove clang-format-*
          sudo apt-get install -t llvm-toolchain-noble-18 clang-format-18

      - name: Format source code
        run: |
          find src include test \
            -type f \
            -a \( -name "*.c" -o -name "*.cpp" -o -name "*.h" \) \
            -print0 \
            | xargs -0 clang-format-18 -i

      - name: Format check
        run: |
          git status --porcelain --untracked-files=no
          git status --porcelain --untracked-files=no | xargs -o -I {} test -z \"{}\"

  codespell:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v5
      - uses: codespell-project/actions-codespell@v2.2

  build-project:
    strategy:
      fail-fast: false
      matrix:
        include:
          - llvm-version: 14
            os: ubuntu-22.04
            preset: develop
          - llvm-version: 21
            os: ubuntu-24.04
            preset: develop

    runs-on: ${{ matrix.os }}
 
    steps:
      - uses: actions/checkout@v5

      - name: LLVM apt
        if: ${{ matrix.llvm-version >= 19 }}
        run: |
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          echo "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-${{ matrix.llvm-version }} main" | sudo tee /etc/apt/sources.list.d/llvm-${{ matrix.llvm-version }}.list

      - name: Update apt
        run: sudo apt-get update

      - name: Install LLVM
        run: sudo apt-get install libllvm${{ matrix.llvm-version }} llvm-${{ matrix.llvm-version }} llvm-${{ matrix.llvm-version }}-dev

      - name: Install Clang
        run: sudo apt-get install clang-${{ matrix.llvm-version }} clang-tidy-${{ matrix.llvm-version }} clang-tools-${{ matrix.llvm-version }} libclang-${{ matrix.llvm-version }}-dev libclang-cpp${{ matrix.llvm-version }}-dev libedit-dev

      - name: Setup env
        run: |
          sudo ln -f -s /usr/bin/clang-${{ matrix.llvm-version }} /usr/bin/clang
          sudo ln -f -s /usr/bin/clang++-${{ matrix.llvm-version }} /usr/bin/clang++
          echo "LLVM_CMAKE_DIR=/usr/lib/llvm-${{ matrix.llvm-version }}/cmake" >> $GITHUB_ENV
          echo "CLANG_CMAKE_DIR=/usr/lib/llvm-${{ matrix.llvm-version }}/lib/cmake/clang" >> $GITHUB_ENV
          echo "EXTERNAL_LIT=/usr/lib/llvm-${{ matrix.llvm-version }}/build/utils/lit/lit.py" >> $GITHUB_ENV

      - name: Build ASTPrinter release
        run: |
          cmake --preset release -DLLVM_DIR=${LLVM_CMAKE_DIR} -DClang_DIR=${CLANG_CMAKE_DIR} -DLLVM_EXTERNAL_LIT=${EXTERNAL_LIT}
          cmake --build build_rel --parallel --target install

      - name: Test and Coverage
        run: |
          cmake --preset coverage -DLLVM_DIR=${LLVM_CMAKE_DIR} -DClang_DIR=${CLANG_CMAKE_DIR} -DLLVM_EXTERNAL_LIT=${EXTERNAL_LIT}
          cmake --build build_cov --target coverage-astprinter

      - name: Upload coverage
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report-llvm${{ matrix.llvm-version }}
          path: build_cov/coverage_report/
